'use strict';

var util = require('util');
var assert = require('assert');
var request = require('request');
var querystring = require('querystring');

module.exports = Scheduler;

/**
 * Thin wrapper of Job Scheduler API
 *
 * @param options Job Scheduler parameters
 */
function Scheduler(options) {
  basicInputValidation(options, ['baseURL']);
  assert(!options.timeout || options.timeout > 0, 'Property "timeout" should be a non-negative number');
  assert(options.token || (options.user && options.password), 'Property "token" or "user", "password" must be provided');
  this._baseURL = options.baseURL;
  if (this._baseURL.slice(-1) !== '/') {
    this._baseURL += '/';
  }
  this._baseURL += 'scheduler';

  this._timeout = ~~options.timeout || 15000; // ms
  this._accessToken = options.token; // caching the access token so that it can be updated
  this._requestDefaults = request.defaults({
    json: true,
    timeout: this._timeout,
    headers : {
      'Authorization' : this._buildAuthHeader(options)
    }
  });
}

Scheduler.prototype.fetchJob = function(options, done) {
  basicInputValidation(options);
  assert(options.jobId || options.name, 'Either property "jobId" or property "name" should be provided');

  var req = {
    method: 'GET',
    uri: this._baseURL + '/jobs',
    qs: options
  };
  this._sendRequest(req, done);
};

Scheduler.prototype.createJob = function(options, done) {
  basicInputValidation(options, ['job']);

  var req = {
    method: 'POST',
    uri: this._baseURL + '/jobs',
    body: options.job
  };
  this._sendRequest(req, done);
};

Scheduler.prototype.updateJob = function(options, done) {
  basicInputValidation(options, ['jobId']);
  this._configureJob(options, options.jobId, done);
};

Scheduler.prototype.upsertJob = function(options, done) {
  basicInputValidation(options, ['name']);
  this._configureJob(options, querystring.escape(options.name), done);
};

Scheduler.prototype._configureJob = function(options, idPath, done) {
  basicInputValidation(options, ['job']);
  assert(idPath);

  var req = {
    method: 'PUT',
    uri: this._baseURL + '/jobs/' + idPath,
    body: options.job
  };
  this._sendRequest(req, done);
};

Scheduler.prototype.fetchJobSchedule = function(options, done) {
  basicInputValidation(options, ['jobId', 'scheduleId']);
  assert(typeof options.displayLogs === 'boolean', 'Property "displayLogs" should be a boolean');

  var req = {
    method: 'GET',
    uri: this._baseURL + '/jobs/' + options.jobId + '/schedules/' + options.scheduleId,
    qs: {
      displayLogs: options.displayLogs
    }
  };
  this._sendRequest(req, done);
};

Scheduler.prototype.createJobSchedule = function(options, done) {
  basicInputValidation(options, ['jobId', 'schedule']);

  var req = {
    method: 'POST',
    uri: this._baseURL + '/jobs/' + options.jobId + '/schedules',
    body: options.schedule
  };
  this._sendRequest(req, done);
};

Scheduler.prototype.updateJobSchedule = function(options, done) {
  basicInputValidation(options, ['jobId', 'scheduleId', 'schedule']);

  var req = {
    method: 'PUT',
    uri: this._baseURL + '/jobs/' + options.jobId + '/schedules/' + options.scheduleId,
    body: options.schedule
  };
  this._sendRequest(req, done);
};

Scheduler.prototype.deleteJobSchedule = function(options, done) {
  basicInputValidation(options, ['jobId', 'scheduleId']);

  var req = {
    method: 'DELETE',
    uri: this._baseURL + '/jobs/' + options.jobId + '/schedules/' + options.scheduleId
  };
  this._sendRequest(req, done);
};

Scheduler.prototype.updateJobRunLog = function(options, done) {
  basicInputValidation(options, ['jobId', 'scheduleId', 'runId', 'data']);

  var req = {
    method: 'PUT',
    uri: options.schedulerUrl || this._baseURL + '/jobs/' + options.jobId + '/schedules/' + options.scheduleId + '/runs/' + options.runId,
    body: options.data
  };
  this._sendRequest(req, done);
};

Scheduler.prototype.getRunLogs = function(options, done) {
  basicInputValidation(options, ['jobId', 'scheduleId']);
  assert(!options.page_size || options.page_size > 0, 'Property "page_size" should be a non-negative integer');
  assert(!options.offset || options.offset > 0, 'Property "offset" should be a non-negative integer');

  var req = {
    method : 'GET',
    uri : this._baseURL + '/jobs/' + options.jobId + '/schedules/' + options.scheduleId + '/runs',
    qs : { 'page_size': options.page_size, offset: options.offset }
  };

  this._sendRequest(req, done);
};

Scheduler.prototype.getRunLogsById = function(options, done) {
  basicInputValidation(options, ['jobId', 'scheduleId', 'runId']);

  var req = {
    method: 'GET',
    uri: this._baseURL + '/jobs/' + options.jobId + '/schedules/' + options.scheduleId + '/runs/' + options.runId
  };

  this._sendRequest(req, done);
};

Scheduler.prototype.fetchJobSchedules = function(options, done) {
  basicInputValidation(options, ['jobId']);

  var req = {
    method: 'GET',
    uri: this._baseURL + '/jobs/' + options.jobId + '/schedules'
  };

  this._sendRequest(req, done);
};

Scheduler.prototype.searchJobs = function(options, done) {
  var req = {
    method: 'GET',
    uri: this._baseURL + '/search/jobs',
    qs: options
  };

  this._sendRequest(req, done);
};

Scheduler.prototype.searchSchedules = function(options, done) {
  var req = {
    method: 'GET',
    uri: this._baseURL + '/search/schedules',
    qs: options
  };

  this._sendRequest(req, done);
};

Scheduler.prototype.deleteJob = function(options, done) {
  basicInputValidation(options, ['jobId']);

  var req = {
    method: 'DELETE',
    uri: this._baseURL + '/jobs/' + options.jobId
  };

  this._sendRequest(req, done);
};

Scheduler.prototype.activateAllSchedules = function(options, done) {
  basicInputValidation(options, ['jobId']);
  options.activeStatus = true;

  var req = {
    method: 'POST',
    uri: this._baseURL + '/jobs/' + options.jobId + '/schedules/activationStatus',
    body: {
      'activationStatus': options.activeStatus
    }
  };

  this._sendRequest(req, done);
};

Scheduler.prototype.deactivateAllSchedules = function(options, done) {
  basicInputValidation(options, ['jobId']);
  options.activeStatus = false;

  var req = {
    method: 'POST',
    uri: this._baseURL + '/jobs/' + options.jobId + '/schedules/activationStatus',
    body: {
      'activationStatus': options.activeStatus
    }
  };

  this._sendRequest(req, done);
};

Scheduler.prototype.deleteAllJobSchedules = function(options, done) {
  basicInputValidation(options, ['jobId']);

  var req = {
    method: 'DELETE',
    uri: this._baseURL + '/jobs/' + options.jobId + '/schedules'
  };

  this._sendRequest(req, done);
};

Scheduler.prototype.getJobCount = function(options, done) {
  basicInputValidation(options);
  if (typeof(options.activeStatus) !== 'boolean') {
    throw new TypeError('Active status value should be a boolean');
  }

  var req = {
    method: 'GET',
    uri: this._baseURL + '/jobCount'
  };

  this._sendRequest(req, function(err, result) {
    if (options.activeStatus === true) {
      delete result.inactive;
      done(err, result);
    } else {
      delete result.active;
      done(err, result);
    }
  });
};

Scheduler.prototype.getJobActionLogs = function(options, done) {
  basicInputValidation(options, ['jobId']);

  var req = {
    method: 'GET',
    uri: this._baseURL + '/actionLogs' + '?jobId=' + options.jobId
  };

  this._sendRequest(req, done);
};

Scheduler.prototype.getScheduleActionLogs = function(options, done) {
  basicInputValidation(options, ['jobId', 'scheduleId']);

  var req = {
    method: 'GET',
    uri: this._baseURL + '/actionLogs' + '?jobId=' + options.jobId + '&scheduleId=' + options.scheduleId
  };

  this._sendRequest(req, done);
};

Scheduler.prototype.fetchAllJobs = function(options, done) {
  var req = {
    method: 'GET',
    uri: this._baseURL + '/jobs',
    qs: options,
  };

  this._sendRequest(req, done);
};

Scheduler.prototype._sendRequest = function(req, done, checkResponse) {
  this._request(req, function (error, response, body) {
    if (error) {
      return done(error);
    }
    var checkOk;
    if (checkResponse) {
      if (typeof checkResponse === 'number') {
        checkOk = response.statusCode === checkResponse;
      } else if (util.isArray(checkResponse)) {
        checkOk = checkResponse.indexOf(response.statusCode) >= 0;
      } else {
        throw new Error('Unsupported type of checkResponse argument');
      }
    } else {
      checkOk = response.statusCode >= 200 && response.statusCode < 300;
    }
    if (!checkOk) {
      return done(responseError(response, body));
    }
    done(null, body);
  });
};

Scheduler.prototype._buildAuthHeader = function(options) {
  if (options.token) {
    return this._buildBearerAuthHeader(options);
  } else if (options.user && options.password) {
    return this._buildBasicAuthHeader(options);
  } else {
    throw new Error('Basic auth credentials or access token should be provided');
  }
};

Scheduler.prototype._buildBasicAuthHeader = function(options) {
  return 'Basic ' + new Buffer(options.user + ':' + options.password).toString('base64');
};

Scheduler.prototype._buildBearerAuthHeader = function(options) {
  return `Bearer ${options.token}`;
};

Scheduler.prototype.setToken = function(token) {
  this._requestDefaults = request.defaults({ // update header
    json: true,
    timeout: this._timeout,
    headers : {
      'Authorization' : this._buildBearerAuthHeader({
        token: token
      })
    }
  });
};

function responseError(response, body) {
  var message = (body && body.message) || ('Status code ' + response.statusCode);
  var err = new Error(message);
  err.statusCode = response.statusCode;
  return err;
}

var debugOn = process.env.NODE_DEBUG && /\bscheduler\b/i.test(process.env.NODE_DEBUG);

Scheduler.prototype._request = function (req, done) {
  if (!debugOn) {
    return this._requestDefaults(req, done);
  }
  console.log('REQUEST:\n%s', JSON.stringify(req, null, 2)); // eslint-disable-line no-console
  return this._requestDefaults(req, function (error, response, body) {
    if (error) {
      console.error('RESPONSE: ', error); // eslint-disable-line no-console
    } else {
      var resp = {
        statusCode: response && response.statusCode,
        headers: response && response.headers,
        body: body
      };
      console.log('RESPONSE:\n%s', JSON.stringify(resp, null, 2)); // eslint-disable-line no-console
    }
    done(error, response, body);
  });
};

function basicInputValidation(obj, arrMandatoryProps) {
  assert(obj, 'Object expected as argument');
  if (!arrMandatoryProps) {
    return;
  }
  arrMandatoryProps.forEach(function (prop) {
    assert(obj[prop], 'Property "' + prop + '" should be provided');
  });
}
